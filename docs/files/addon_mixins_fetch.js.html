<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>addon/mixins/fetch.js - Ember JSON API Resources</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Ember JSON API Resources" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ApplicationAdapter.html">ApplicationAdapter</a></li>
                                <li><a href="../classes/ApplicationSerializer.html">ApplicationSerializer</a></li>
                                <li><a href="../classes/AuthorizationMixin.html">AuthorizationMixin</a></li>
                                <li><a href="../classes/FetchMixin.html">FetchMixin</a></li>
                                <li><a href="../classes/RelatedProxyUtil.html">RelatedProxyUtil</a></li>
                                <li><a href="../classes/Resource.html">Resource</a></li>
                                <li><a href="../classes/ServiceCacheMixin.html">ServiceCacheMixin</a></li>
                                <li><a href="../classes/StoreService.html">StoreService</a></li>
                                <li><a href="../classes/TransformDateAttribute.html">TransformDateAttribute</a></li>
                                <li><a href="../classes/TransformMap.html">TransformMap</a></li>
                                <li><a href="../classes/TransformsMixin.html">TransformsMixin</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/adapter.html">adapter</a></li>
                                <li><a href="../modules/authorization.html">authorization</a></li>
                                <li><a href="../modules/cache.html">cache</a></li>
                                <li><a href="../modules/ember-jsonapi-resources.html">ember-jsonapi-resources</a></li>
                                <li><a href="../modules/fetch.html">fetch</a></li>
                                <li><a href="../modules/resource.html">resource</a></li>
                                <li><a href="../modules/serializer.html">serializer</a></li>
                                <li><a href="../modules/store.html">store</a></li>
                                <li><a href="../modules/transform-map.html">transform-map</a></li>
                                <li><a href="../modules/transforms.html">transforms</a></li>
                                <li><a href="../modules/utils.html">utils</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: addon/mixins/fetch.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
  @module ember-jsonapi-resources
  @submodule fetch
**/
import Ember from &#x27;ember&#x27;;

/**
  Fetch/Ajax methods for use with an Adapter calls &#x60;cacheUpdate&#x60;, &#x60;cacheResource&#x60;
  methods and a &#x60;serializer&#x60; injection.

  @class FetchMixin
*/
export default Ember.Mixin.create({
  /**
    Flag indicates whether to use window.fetch or not

    @property useFetch
    @type Boolean
  */
  useFetch: Ember.computed(&#x27;useAjax&#x27;, function () {
    let notFirefox = window.navigator.userAgent.indexOf(&quot;Firefox&quot;) === -1;
    return !this.get(&#x27;useAjax&#x27;) &amp;&amp; window.fetch &amp;&amp; notFirefox;
  }),

  /**
    Flag to use $.ajax instead of window.fetch

    @property useAjax
    @type Boolean
  */
  useAjax: false,

  /**
    Makes a fetch request via Fetch API (may use polyfill)

    see http://updates.html5rocks.com/2015/03/introduction-to-fetch

    @private
    @method _fetch
    @param {String} url
    @param {Object} options - may include a query object or an update flag
    @param {Boolean} isUpdate
    @return {Ember.RSVP.Promise}
  */
  _fetch(url, options, isUpdate) {
    let _this = this;
    return new Ember.RSVP.Promise(function(resolve, reject) {
      window.fetch(url, options).then(function(resp) {
        if (resp.status &gt;= 500) {
          let msg = &#x27;The Service responded with a &#x27;+ resp.status +&#x27; error.&#x27;;
          reject(new ServerError(msg, resp));
        } else if (resp.status &gt;= 400) {
          resp.text().then(function(_resp) {
            let json, msg = &#x27;The API responded with a &#x27;+ resp.status +&#x27; error.&#x27;;
            try {
              json = JSON.parse(_resp);
            } catch (e) {
              Ember.Logger.error(e);
              json = { &quot;errors&quot;: [ { &quot;status&quot;: resp.status } ] };
            }
            reject(new ClientError(msg, json));
          });
        } else if (resp.status === 204) {
          resolve(&#x27;&#x27;);
        } else {
          return resp.json().then(function(json) {
            if (isUpdate) {
              json.data = _this.serializer.transformAttributes(json.data);
              _this.cacheUpdate({ meta: json.meta, data: json.data, headers: resp.headers });
              resolve(json.data);
            } else {
              let resource = _this.serializer.deserialize(json);
              _this.cacheResource({ meta: json.meta, data: resource, headers: resp.headers });
              _this.serializer.deserializeIncluded(json.included, { headers: resp.headers });
              resolve(resource);
            }
          });
        }
      }).catch(function(error) {
        let msg = (error &amp;&amp; error.message) ? error.message : &#x27;Unable to Fetch resource(s)&#x27;;
        reject(new FetchError(msg, error));
      });
    });
  },

  /**
    Makes an XHR request via $.ajax

    @private
    @method _ajax
    @param {String} url
    @param {Object} options - may include a query object or an update flag
    @param {Boolean} isUpdate
    @return {Ember.RSVP.Promise}
    @requires jQuery
  */
  _ajax(url, options, isUpdate) {
    options.data = options.body;
    delete options.body;
    let _this = this;
    return new Ember.RSVP.Promise(function(resolve, reject) {
      Ember.$.ajax(url, options).done(function(json, textStatus, jqXHR) {
        if (jqXHR.status === 204) {
          resolve(&#x27;&#x27;);
        } else {
          let headers = _this._getAjaxHeaders(jqXHR);
          if (isUpdate) {
            json.data = _this.serializer.transformAttributes(json.data);
            _this.cacheUpdate({ meta: json.meta, data: json.data, headers: headers });
            resolve(json.data);
          } else {
            let resource = _this.serializer.deserialize(json);
            _this.cacheResource({ meta: json.meta, data: resource, headers: headers });
            _this.serializer.deserializeIncluded(json.included, { headers: headers });
            resolve(resource);
          }
        }
      }).fail(function(jqXHR, textStatus, errorThrown) {
        let msg;
        if (jqXHR.status &gt;= 500) {
          msg = &#x27;The Service responded with &#x27; + textStatus + &#x27; &#x27; + jqXHR.status;
          reject(new ServerError(msg, jqXHR.responseJSON || jqXHR.responseText));
        } else if (jqXHR.status &gt;= 400) {
          msg = &#x27;The API responded with a &#x27;+ jqXHR.status +&#x27; error.&#x27;;
          let json = jqXHR.responseJSON;
          if (!json) {
            json = { &quot;errors&quot;: [ { &quot;status&quot;: jqXHR.status, &quot;detail&quot;: jqXHR.responseText } ] };
          }
          reject(new ClientError(msg, json));
        } else {
          msg = (errorThrown) ? errorThrown : &#x27;Unable to Fetch resource(s)&#x27;;
          reject(new FetchError(msg, {
            code: jqXHR.status,
            message: errorThrown,
            &#x27;status&#x27;: textStatus,
            response: jqXHR.responseText
          }));
        }
      });
    });
  },

  /**
    @private
    @method _getXHRHeaders
    @param {Object} jqXHR
    @return {Object}
  */
  _getAjaxHeaders(jqXHR) {
    let headers = jqXHR.getAllResponseHeaders();
    headers = headers.split(&#x27;\n&#x27;);
    let headersDictionary = {}, key, value, header;
    for (let i = 0; i &lt; headers.length; i++) {
      header = headers[i].split(&#x27;: &#x27;);
      if (header[0].trim() !== &#x27;&#x27;) {
        key = header[0].trim();
        value = header[1].trim();
        headersDictionary[key] = value;
      }
    }
    return headersDictionary;
  }

});

function ServerError(message = &#x27;Server Error&#x27;, response = null) {
  let _error = Error.prototype.constructor.call(this, message);
  _error.name = this.name = &#x27;ServerError&#x27;;
  this.stack = _error.stack;
  this.message = _error.message;

  this.response = response;
  this.errors = (response) ? response.errors || null : null;
}
ServerError.prototype = errorProtoFactory(ServerError);

function ClientError(message = &#x27;Client Error&#x27;, response = null) {
  let _error = Error.prototype.constructor.call(this, message);
  _error.name = this.name = &#x27;ClientError&#x27;;
  this.stack = _error.stack;
  this.message = _error.message;

  this.response = response;
  this.errors = (response) ? response.errors || null : null;
}
ClientError.prototype = errorProtoFactory(ClientError);

function FetchError(message = &#x27;Fetch Error&#x27;, error = null, response = null) {
  let _error = Error.prototype.constructor.call(this, message);
  _error.name = this.name = &#x27;FetchError&#x27;;
  this.stack = (error &amp;&amp; error.stack) ? error.stack : _error.stack;
  this.message = (error &amp;&amp; error.message) ? error.message : _error.message;

  this.response = response;
  this.error = error || _error;
}
FetchError.prototype = errorProtoFactory(FetchError);

function errorProtoFactory(ctor) {
  return Object.create(Error.prototype, {
    constructor: {
      value: ctor,
      writable: true,
      configurable: true
    }
  });
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
