<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>addon/models/resource.js - Ember JSON API Resources</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Ember JSON API Resources" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ApplicationAdapter.html">ApplicationAdapter</a></li>
                                <li><a href="../classes/ApplicationSerializer.html">ApplicationSerializer</a></li>
                                <li><a href="../classes/AuthorizationMixin.html">AuthorizationMixin</a></li>
                                <li><a href="../classes/FetchMixin.html">FetchMixin</a></li>
                                <li><a href="../classes/RelatedProxyUtil.html">RelatedProxyUtil</a></li>
                                <li><a href="../classes/Resource.html">Resource</a></li>
                                <li><a href="../classes/ServiceCacheMixin.html">ServiceCacheMixin</a></li>
                                <li><a href="../classes/StoreService.html">StoreService</a></li>
                                <li><a href="../classes/TransformDateAttribute.html">TransformDateAttribute</a></li>
                                <li><a href="../classes/TransformMap.html">TransformMap</a></li>
                                <li><a href="../classes/TransformsMixin.html">TransformsMixin</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/adapter.html">adapter</a></li>
                                <li><a href="../modules/authorization.html">authorization</a></li>
                                <li><a href="../modules/cache.html">cache</a></li>
                                <li><a href="../modules/ember-jsonapi-resources.html">ember-jsonapi-resources</a></li>
                                <li><a href="../modules/fetch.html">fetch</a></li>
                                <li><a href="../modules/resource.html">resource</a></li>
                                <li><a href="../modules/serializer.html">serializer</a></li>
                                <li><a href="../modules/store.html">store</a></li>
                                <li><a href="../modules/transform-map.html">transform-map</a></li>
                                <li><a href="../modules/transforms.html">transforms</a></li>
                                <li><a href="../modules/utils.html">utils</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: addon/models/resource.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
  @module ember-jsonapi-resources
  @submodule resource
**/

import Ember from &#x27;ember&#x27;;
import { pluralize, singularize } from &#x27;ember-inflector&#x27;;
import attr from &#x27;ember-jsonapi-resources/utils/attr&#x27;;
import hasOne from &#x27;ember-jsonapi-resources/utils/has-one&#x27;;
import hasMany from &#x27;ember-jsonapi-resources/utils/has-many&#x27;;
import { isType } from &#x27;ember-jsonapi-resources/utils/is&#x27;;

/**
  A Resource class to create JSON API resource objects

  See &lt;http://jsonapi.org/format/#document-resource-objects&gt;

  @class Resource
  @requires Ember.Inflector
  @static
*/
const Resource = Ember.Object.extend({

  /**
    The service object for the entity (adapter with cache and serializer)

    @property service
    @type Object
    @required
  */
  service: null,

  /**
    Extending Prototypes Must define a &#x60;type&#x60; value for the entity, e.g. &#x60;posts&#x60;

    @property type
    @type String
    @required
  */
  type: null,

  /**
    Persisted resource ID value

    @property id
    @type String
    @required
  */
  id: null,

  /**
    An optional &#x60;attributes&#x60; property of for a JSON API Resource object, setup in create()

    This object will keep the values from the response object and may be mutable
    Use this as a refence for creating computed properties

    For example the &#x60;attr()&#x60; helper sets up a properties based on this content

    @protected
    @property attributes
    @type Object
  */
  attributes: null,

  /**
    An optional &#x60;relationships&#x60; property of for a JSON API Resource object, setup in create()

    @protected
    @property relationships
    @type Object
  */
  relationships: null,

  /**
    An optional &#x60;links&#x60; property of for a JSON API Resource object, setup in create()

    @protected
    @property links
    @type Object
  */
  links: null,

  /**
    An optional property of for a JSON API Resource object, setup in create()

    @protected
    @property meta
    @type Object
  */
  meta: null,

  /**
    Hash of attributes for changed/previous values

    @private
    @property _attributes
    @type Object
  */
  _attributes: null,

  /**
    Flag for new instance, e.g. not peristed

    @property isNew
    @type Boolean
  */
  isNew: false,

  /**
    Custom &#x60;toString&#x60; method used for clarity that the instance is a JSON API Resource kind of object

    @method toString
  */
  toString() {
    let type = this.get(&#x27;type&#x27;) || &#x27;null&#x27;;
    let id = this.get(&#x27;id&#x27;) || &#x27;null&#x27;;
    return &#x60;[JSONAPIResource|${type}:${id}]&#x60;;
  },

  /**
    Update a relation by adding or removing using a list, id, or null. When
    adding an id for a to-many relation send one or more ids, include the
    existing ids as well. When removing from a to-many relation pass the ids
    that should remain, missing ids will be removed, or remove all with an empty
    array. When operating on a to-one relation just use the id to change the
    relation, or null to remove.

    This is not a replace operation, but rather support for editing as a set.

    @method updateRelationship
    @param {String} relation
    @param {Array|String|null} ids
  */
  updateRelationship(relation, ids) {
    let relationshipData = &#x27;relationships.&#x27; + relation + &#x27;.data&#x27;;
    let existing;
    if (!Array.isArray(ids)) {
      existing = this.get(relationshipData).id;
      this.removeRelationship(relation, existing);
      if (isType(&#x27;string&#x27;, ids)) {
        this.addRelationship(relation, ids);
      }
    } else {
      existing = this.get(relationshipData).map(function(rel) { return rel.id; });
      if (!existing.length) {
        this.addRelationships(relation, ids);
      } else if (ids.length &gt; existing.length) {
        this.addRelationships(relation, unique(ids, existing));
      } else if (existing.length &gt; ids.length) {
        this.removeRelationships(relation, unique(existing, ids));
      }
    }
    return this.get(&#x27;service&#x27;).patchRelationship(this, relation);
  },

  /**
    @method addRelationships
    @param {String} related - resource name
    @param {Array} ids
  */
  addRelationships(related, ids) {
    for (let i = 0; i &lt; ids.length; i++) {
      this.addRelationship(related, ids[i]);
    }
  },

  /**
    @method removeRelationships
    @param {String} related - resource name
    @param {Array} ids
  */
  removeRelationships(related, ids) {
    for (let i = 0; i &lt; ids.length; i++) {
      this.removeRelationship(related, ids[i]);
    }
  },

  /**
    Adds related links object on the relationship hash

    @method addRelationship
    @param {String} related - resource name
    @param {String} id
  */
  addRelationship(related, id) {
    const key = [&#x27;relationships&#x27;, related, &#x27;data&#x27;].join(&#x27;.&#x27;);
    let data = this.get(key);
    const type = pluralize(related);
    const linkage = { type: type, id: id };
    if (Array.isArray(data)) {
      data.push(linkage);
    } else {
      data = linkage;
    }
    return this.set(key, data);
  },

  /**
    Remove related links object on the relationship hash to have &#x60;null&#x60; data

    @method removeRelationship
    @param {String} related - resource name
    @param {String} id
  */
  removeRelationship(related, id) {
    let relation = this.get(&#x27;relationships.&#x27; + related);
    if (Array.isArray(relation.data)) {
      for (let i = 0; i &lt; relation.data.length; i++) {
        if (relation.data[i].id === id) {
          relation.data.splice(i, 1);
          break;
        }
      }
    } else if (typeof relation === &#x27;object&#x27;) {
      relation.data = null;
    }
  },

  /**
    @method changedAttributes
    @return {Object} the changed attributes
  */
  changedAttributes: Ember.computed(&#x27;attributes&#x27;, {
    get: function () {
      const attrs = {};
      for (let key in this._attributes) {
        if (this._attributes.hasOwnProperty(key)) {
          if (this._attributes[key].changed !== this._attributes[key].previous) {
            attrs[key] = this._attributes[key].changed;
          }
        }
      }
      return attrs;
    }
  }).volatile(),

  /**
    @method previousAttributes
    @return {Object} the previous attributes
  */
  previousAttributes: Ember.computed(&#x27;attributes&#x27;, {
    get: function () {
      const attrs = {};
      for (let key in this._attributes) {
        if (this._attributes.hasOwnProperty(key)) {
          if (this._attributes[key].changed !== this._attributes[key].previous) {
            attrs[key] = this._attributes[key].previous;
          }
        }
      }
      return attrs;
    }
  }).volatile(),

  /**
    Initialize events to communicate with the service object, listen for &#x60;didUpdateResource&#x60;

    @method initEvents
  */
  initEvents: Ember.on(&#x27;init&#x27;, function () {
    const service = this.get(&#x27;service&#x27;);
    if (service) {
      service.on(&#x27;didUpdateResource&#x27;, this, this.didUpdateResource);
    }
  }),

  /**
    Handler for &#x60;didUpdateResource&#x60; event, resets private _attributes used for changed/previous tracking

    @method didUpdateResource
    @param json the updated data for the resource
  */
  didUpdateResource(json) {
    if (this.get(&#x27;id&#x27;) !== json.id) { return; }
    this.setProperties(json);
    for (let attr in this._attributes) {
      if (this._attributes.hasOwnProperty(attr)) {
        delete this._attributes[attr];
      }
    }
  },

  /**
    A local cache duration, to minimize duplicate fetch requests

    @property cacheDuration
    @type Number
  */
  cacheDuration: /* minutes */ 7 * /* seconds */ 60 * /* milliseconds */ 1000,

  /**
    @property isCacheExpired
    @type Boolean
  */
  isCacheExpired: Ember.computed(&#x27;meta.timeStamps.local&#x27;, &#x27;cacheDuration&#x27;, function () {
    const localTime = this.get(&#x27;meta.timeStamps.local&#x27;);
    const expiresTime = localTime + this.get(&#x27;cacheDuration&#x27;);
    return (localTime) ? Date.now() &gt;= expiresTime : false;
  })
});

Resource.reopenClass({
  /**
    To protect the JSON API Resource properties for attributes, links and
    relationships these objects are setup during create(). This has to be
    defined since the attr() helper needs to have new objects for each instance,
    to project from keeping a reference on the prototype.

    The create method should only be called after looking up a factory from the
    container, for example in a route&#x27;s model hook:

    &#x60;&#x60;&#x60;
    model() {
      return this.container.lookupFactory(&#x27;model:posts&#x27;).create({
        attributes: {
          title: &#x27;The JSON API 1.0 Spec Rocks!&#x27;
        }
      });
    }
    &#x60;&#x60;&#x60;

    The create method uses the container to lookup the factory&#x27;s prototype and
    find the computed properties used for relations to setup the relationships
    for the Resource instance you create. Calling Resource#create without using
    the factory lookup will result in an instance without a reference to the
    application&#x27;s container and you will have to manually setup the relationships
    object prior to adding a relationship.

    @method create
    @return {Resource} instance with protected objects:
      &#x60;attributes&#x60;, &#x60;links&#x60; and &#x60;relationships&#x60;
  */
  create(properties) {
    const prototype = {};
    const attrs = Ember.String.w(&#x27;_attributes attributes links meta relationships&#x27;);
    for (let i = 0; i &lt; attrs.length; i++) {
      prototype[attrs[i]] = {};
    }
    const instance = this._super(prototype);
    if (properties) {
      instance.setProperties(properties);
    }
    let type = instance.get(&#x27;type&#x27;);
    let msg = (type) ? Ember.String.capitalize(singularize(type)) : &#x27;Resource&#x27;;
    let factory = &#x27;model:&#x27; + type;
    if (!type) {
      Ember.Logger.warn(msg + &#x27;#create called, instead you should first use &#x27; + msg + &#x27;.extend({type:&quot;entity&quot;})&#x27;);
    } else {
      if (instance.container) {
        useComputedPropsMetaToSetupRelationships(factory, instance);
      } else {
        msg += &#x27;#create should only be called from a container lookup (relationships not setup) &#x27;;
        msg += &#x27;use this.container.lookupFactory(&quot;&#x27; + factory + &#x27;&quot;).create() instead.&#x27;;
        Ember.Logger.warn(msg);
      }
    }
    return instance;
  }
});

export default Resource;

export { attr, hasOne, hasMany };

let _rp = &#x27;service type id attributes relationships links meta _attributes isNew cacheDuration isCacheExpired&#x27;;
const ignoredMetaProps = _rp.split(&#x27; &#x27;);

function useComputedPropsMetaToSetupRelationships(factory, instance) {
  factory = instance.container.lookupFactory(factory);
  factory.eachComputedProperty(function(prop) {
    if (ignoredMetaProps.indexOf(prop) &gt; -1) { return; }
    try {
      let meta = factory.metaForProperty(prop);
      if (meta &amp;&amp; meta.kind) {
        if (meta.kind === &#x27;hasOne&#x27;) {
          setupRelationship.call(instance, prop);
        } else if (meta.kind === &#x27;hasMany&#x27;) {
          setupRelationship.call(instance, prop, Ember.A([]));
        }
      }
    } catch (e) {
      return; // metaForProperty has an assertion that may throw
    }
  });
}

function setupRelationship(relation, data = null) {
  if (!this.relationships[relation]) {
    this.relationships[relation] = { links: {}, data: data };
  }
  if (!this.relationships[relation].links) {
    this.relationships[relation].links = {};
  }
  if (!this.relationships[relation].data) {
    this.relationships[relation].data = data;
  }
}

function unique(superSet, subSet) {
  let intersection = superSet.filter(function (item) {
    return subSet.indexOf(item) !== -1;
  });
  let _unique = superSet.filter(function (item) {
    return intersection.indexOf(item) === -1;
  });
  return (unique.length) ? _unique : subSet;
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
